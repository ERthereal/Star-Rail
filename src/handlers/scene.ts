import { AvatarType, EntityType } from "../../resources/autogenerated/common.define";
import { AvatarSkillTree, BattleAvatar, BattleEndStatus, BattleEquipment } from "../../resources/autogenerated/common.gamecore";
import { GetCurBattleInfoCsReq, GetCurBattleInfoScRsp, QuitBattleCsReq, QuitBattleScRsp } from "../../resources/autogenerated/cs.battle";
import { SceneBattleInfo } from "../../resources/autogenerated/cs.common";
import { ExtraLineupType, GetCurLineupDataCsReq, GetCurLineupDataScRsp, LineupAvatar, LineupInfo } from "../../resources/autogenerated/cs.lineup";
import { GetCurSceneInfoCsReq, GetCurSceneInfoScRsp, MotionInfo, SceneActorInfo, SceneEntityInfo, SceneEntityUpdateScNotify, SceneInfo, Vector } from "../../resources/autogenerated/cs.scene";
import { PacketContext, RouteManager } from "../network/route";

export class SceneHandler {
    constructor(routeManager: RouteManager) {
        routeManager.on(GetCurSceneInfoCsReq, this.GetCurSceneInfoCsReq);
        routeManager.on(GetCurLineupDataCsReq, this.GetCurLineupDataCsReq);
        routeManager.on(GetCurBattleInfoCsReq, this.GetCurBattleInfoCsReq);
        routeManager.on(QuitBattleCsReq, this.QuitBattleCsReq);
    }

    public QuitBattleCsReq(context: PacketContext<QuitBattleCsReq>) {
        const rsp = QuitBattleScRsp.create();
        rsp.retcode = 0;
        context.send(QuitBattleScRsp, rsp);
    }

    public GetCurBattleInfoCsReq(context: PacketContext<GetCurBattleInfoCsReq>) {
        const rsp = GetCurBattleInfoScRsp.create();
        rsp.retcode = 0;
        rsp.lastEndStatus = BattleEndStatus.BATTLE_END_NONE;
        rsp.lastEventId = 0;
        rsp.logicRandomSeed = 233;
        rsp.stageId = 10000;

        rsp.avatarList = [
            BattleAvatar.create({
                avatarType: AvatarType.AVATAR_FORMAL_TYPE,
                equipmentList: [],
                hp: 1000,
                id: 1001,
                index: 1,
                level: 60,
                promotion: 1,
                rank: 1,
                relicList: [],
                skilltreeList: [
                    AvatarSkillTree.create({
                        level: 1,
                        pointId: 100101
                    }),
                ],
                sp: 1000,
            })
        ];

        rsp.battleInfo = SceneBattleInfo.create({
            battleAvatarList: [
                BattleAvatar.create({
                    avatarType: AvatarType.AVATAR_FORMAL_TYPE,
                    equipmentList: [],
                    hp: 1000,
                    id: 1001,
                    index: 1,
                    level: 60,
                    promotion: 1,
                    rank: 1,
                    relicList: [],
                    skilltreeList: [
                        AvatarSkillTree.create({
                            level: 1,
                            pointId: 100101
                        }),
                    ],
                    sp: 1000,
                })
            ],
            battleId: 1,
            buffList: [],
            heroPathList: [],
            logicRandomSeed: 233,
            monsterWaveList: [],
            roundsLimit: 0,
            stageId: 10001
        });
        context.send(GetCurBattleInfoScRsp, rsp);
    }

    public GetCurLineupDataCsReq(context: PacketContext<GetCurLineupDataCsReq>) {
        const rsp = GetCurLineupDataScRsp.create();
        rsp.retcode = 0;
        rsp.lineup = LineupInfo.create({
            avatarList: [
                LineupAvatar.create({
                    avatarType: AvatarType.AVATAR_FORMAL_TYPE,
                    hp: 1000,
                    id: 1001,
                    satiety: 10,
                    slot: 1,
                    sp: 1,
                })
            ],
            name: "CloudySR",
            extraLineupType: ExtraLineupType.LINEUP_NONE,
            index: 0,
            leaderSlot: 0,
            planeId: 10000,
            isVirtual: true,
            mp: 0,
        });
        context.send(GetCurLineupDataScRsp, rsp);
    };

    public GetCurSceneInfoCsReq(context: PacketContext<GetCurSceneInfoCsReq>) {
        const entityId = (EntityType.ENTITY_AVATAR << 24) + 1;
        const rsp = GetCurSceneInfoScRsp.create();
        rsp.retcode = 0;
        rsp.scene = SceneInfo.create({
            entityBuffList: [],
            entityList: [
                SceneEntityInfo.create({
                    entityId: entityId,
                    groupId: 1,
                    instId: 1,
                    motion: MotionInfo.create({
                        pos: Vector.create({
                            x: 100,
                            y: 100,
                            z: 100,
                        }),
                        rot: Vector.create({
                            x: 0,
                            y: 0,
                            z: 0,
                        }),
                    }),
                    entity: {
                        "oneofKind": "actor",
                        "actor": SceneActorInfo.create({
                            avatarType: AvatarType.AVATAR_FORMAL_TYPE,
                            baseAvatarId: 1001,
                            uid: 1,
                        })
                    }
                })
            ],
            entryId: 1,
            envBuffList: [],
            floorId: 10000000,
            gameModeType: 0,
            lightenSectionList: [],
            leaderEntityId: entityId,
            planeId: 10000,
        });
        context.send(GetCurSceneInfoScRsp, rsp);
    }
}